"""
æ–°èæœå°‹èˆ‡åˆ†æ AI Service - Streamlit + RAG + Ollama ç‰ˆæœ¬

åŠŸèƒ½ç‰¹è‰²:
1. æœ¬åœ° LLM (Ollama) - å…è²»ã€é›¢ç·šå¯ç”¨
2. RAG å‘é‡æª¢ç´¢ - æ™ºèƒ½å•ç­”
3. æ–°èçŸ¥è­˜åº« - æŒä¹…åŒ–å­˜å„²
4. æ··åˆæ¨¡å¼ - æ”¯æ´ OpenAI + Ollama

å®‰è£:
pip install streamlit ollama chromadb sentence-transformers openai feedparser requests beautifulsoup4 plotly

ä½¿ç”¨:
streamlit run streamlit_rag_app.py
"""

import streamlit as st
import ollama
from openai import OpenAI
import os
from datetime import datetime
import json
import feedparser
from bs4 import BeautifulSoup
import plotly.express as px
import plotly.graph_objects as go

# RAG ç›¸é—œ
import chromadb
from chromadb.config import Settings
from sentence_transformers import SentenceTransformer

# é é¢é…ç½®
st.set_page_config(
    page_title="RAG + Ollama æ–°èåˆ†æ",
    page_icon="ğŸ¤–",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ============ RAG ç³»çµ±é¡åˆ¥ ============

class NewsRAGSystem:
    """æ–°è RAG ç³»çµ±"""
    
    def __init__(self, model_name="llama3.2", collection_name="news_collection"):
        self.model_name = model_name
        self.collection_name = collection_name
        
        # åˆå§‹åŒ– Embedding æ¨¡å‹
        if 'embedding_model' not in st.session_state:
            with st.spinner("è¼‰å…¥ Embedding æ¨¡å‹..."):
                st.session_state.embedding_model = SentenceTransformer('all-MiniLM-L6-v2')
        self.embedding_model = st.session_state.embedding_model
        
        # åˆå§‹åŒ– ChromaDB
        if 'chroma_client' not in st.session_state:
            st.session_state.chroma_client = chromadb.Client(Settings(
                persist_directory="./chroma_db",
                anonymized_telemetry=False
            ))
        self.chroma_client = st.session_state.chroma_client
        
        # ç²å–æˆ–å‰µå»ºé›†åˆ
        try:
            self.collection = self.chroma_client.get_collection(collection_name)
        except:
            self.collection = self.chroma_client.create_collection(
                name=collection_name,
                metadata={"description": "æ–°èæ–‡ç« å‘é‡å­˜å„²"}
            )
    
    def add_news(self, news_list):
        """æ·»åŠ æ–°èåˆ°å‘é‡è³‡æ–™åº«"""
        if not news_list:
            return
        
        documents = []
        metadatas = []
        ids = []
        
        for idx, news in enumerate(news_list):
            text = f"{news['title']}\n{news.get('summary', '')}"
            documents.append(text)
            
            metadatas.append({
                "title": news['title'],
                "source": news['source'],
                "link": news.get('link', ''),
                "published": news.get('published', ''),
                "category": news.get('category', '')
            })
            
            ids.append(f"news_{datetime.now().timestamp()}_{idx}")
        
        embeddings = self.embedding_model.encode(documents).tolist()
        
        self.collection.add(
            documents=documents,
            embeddings=embeddings,
            metadatas=metadatas,
            ids=ids
        )
        
        return len(news_list)
    
    def search_similar_news(self, query, n_results=5):
        """æœå°‹ç›¸ä¼¼æ–°è"""
        query_embedding = self.embedding_model.encode([query]).tolist()
        
        results = self.collection.query(
            query_embeddings=query_embedding,
            n_results=n_results
        )
        
        similar_news = []
        for i in range(len(results['documents'][0])):
            similar_news.append({
                "content": results['documents'][0][i],
                "metadata": results['metadatas'][0][i],
                "distance": results['distances'][0][i] if 'distances' in results else None
            })
        
        return similar_news
    
    def query_with_rag(self, question, n_context=3):
        """ä½¿ç”¨ RAG å›ç­”å•é¡Œ"""
        similar_news = self.search_similar_news(question, n_results=n_context)
        
        context = "\n\n".join([
            f"ã€æ–°è {i+1}ã€‘\nä¾†æº: {news['metadata']['source']}\nå…§å®¹: {news['content']}"
            for i, news in enumerate(similar_news)
        ])
        
        prompt = f"""åŸºæ–¼ä»¥ä¸‹æ–°èå…§å®¹å›ç­”å•é¡Œã€‚

ç›¸é—œæ–°è:
{context}

å•é¡Œ: {question}

è«‹åŸºæ–¼ä¸Šè¿°æ–°èå…§å®¹æä¾›æº–ç¢ºã€å®¢è§€çš„å›ç­”ã€‚å¦‚æœæ–°èä¸­æ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œè«‹æ˜ç¢ºèªªæ˜ã€‚"""

        response = ollama.chat(
            model=self.model_name,
            messages=[{
                'role': 'user',
                'content': prompt
            }]
        )
        
        return response['message']['content'], similar_news
    
    def get_statistics(self):
        """ç²å–çµ±è¨ˆ"""
        try:
            return {
                "total_news": self.collection.count(),
                "collection_name": self.collection_name,
                "model": self.model_name
            }
        except:
            return {"total_news": 0}

# ============ å·¥å…·å‡½æ•¸ ============

NEWS_SOURCES = {
    "liberty_times": {
        "name": "è‡ªç”±æ™‚å ±",
        "rss": "https://news.ltn.com.tw/rss/all.xml",
        "category": "ç¶œåˆ"
    },
    "taipei_times": {
        "name": "Taipei Times",
        "rss": "https://www.taipeitimes.com/xml/index.rss",
        "category": "è‹±æ–‡æ–°è"
    }
}

def fetch_rss_news(source_key=None, limit=10):
    """æŠ“å– RSS æ–°è"""
    news_list = []
    sources = {source_key: NEWS_SOURCES[source_key]} if source_key else NEWS_SOURCES
    
    for key, source in sources.items():
        try:
            feed = feedparser.parse(source['rss'])
            for entry in feed.entries[:limit]:
                news_item = {
                    "source": source['name'],
                    "title": entry.get('title', 'No title'),
                    "link": entry.get('link', ''),
                    "published": entry.get('published', ''),
                    "summary": entry.get('summary', '')[:200] + "..." if entry.get('summary') else '',
                    "category": source['category']
                }
                news_list.append(news_item)
        except:
            pass
    
    return news_list

def check_ollama_status():
    """æª¢æŸ¥ Ollama ç‹€æ…‹"""
    try:
        ollama.list()
        return True
    except:
        return False

def list_ollama_models():
    """åˆ—å‡ºå¯ç”¨æ¨¡å‹"""
    try:
        models = ollama.list()
        return [model['name'] for model in models['models']]
    except:
        return []

# ============ Session State åˆå§‹åŒ– ============

if 'rag_system' not in st.session_state:
    st.session_state.rag_system = None
if 'ollama_model' not in st.session_state:
    st.session_state.ollama_model = 'llama3.2'
if 'use_ollama' not in st.session_state:
    st.session_state.use_ollama = True
if 'search_results' not in st.session_state:
    st.session_state.search_results = []

# ============ å´é‚Šæ¬„ ============

with st.sidebar:
    st.title("ğŸ¤– RAG + Ollama")
    st.markdown("---")
    
    # Ollama ç‹€æ…‹æª¢æŸ¥
    st.subheader("ğŸ“¡ Ollama ç‹€æ…‹")
    
    if check_ollama_status():
        st.success("âœ… Ollama é‹è¡Œä¸­")
        
        # æ¨¡å‹é¸æ“‡
        available_models = list_ollama_models()
        if available_models:
            model_options = [m.split(':')[0] for m in available_models]
            selected_model = st.selectbox(
                "é¸æ“‡æ¨¡å‹",
                model_options,
                index=0 if st.session_state.ollama_model not in model_options else model_options.index(st.session_state.ollama_model)
            )
            st.session_state.ollama_model = selected_model
            
            st.info(f"ğŸ¯ ç•¶å‰æ¨¡å‹: **{selected_model}**")
        else:
            st.warning("âš ï¸ æœªæ‰¾åˆ°å·²å®‰è£çš„æ¨¡å‹")
            st.code("ollama pull llama3.2", language="bash")
        
        st.session_state.use_ollama = True
        
    else:
        st.error("âŒ Ollama æœªé‹è¡Œ")
        st.markdown("""
        **å®‰è£ Ollama:**
        - [ä¸‹è¼‰ Ollama](https://ollama.com/download)
        
        **å•Ÿå‹•æœå‹™:**
        ```bash
        ollama serve
        ```
        
        **ä¸‹è¼‰æ¨¡å‹:**
        ```bash
        ollama pull llama3.2
        ```
        """)
        st.session_state.use_ollama = False
    
    st.markdown("---")
    
    # RAG ç³»çµ±åˆå§‹åŒ–
    st.subheader("ğŸ—„ï¸ RAG çŸ¥è­˜åº«")
    
    if st.button("ğŸš€ åˆå§‹åŒ– RAG ç³»çµ±", use_container_width=True):
        with st.spinner("åˆå§‹åŒ–ä¸­..."):
            try:
                st.session_state.rag_system = NewsRAGSystem(
                    model_name=st.session_state.ollama_model
                )
                st.success("âœ… RAG ç³»çµ±åˆå§‹åŒ–å®Œæˆ")
            except Exception as e:
                st.error(f"âŒ åˆå§‹åŒ–å¤±æ•—: {e}")
    
    # çµ±è¨ˆè³‡è¨Š
    if st.session_state.rag_system:
        stats = st.session_state.rag_system.get_statistics()
        st.metric("çŸ¥è­˜åº«æ–°èæ•¸", stats['total_news'])
        st.metric("å‘é‡é›†åˆ", stats['collection_name'])
    
    st.markdown("---")
    
    # æ¨¡å‹æ¯”è¼ƒ
    with st.expander("ğŸ“Š æ¨¡å‹ç‰¹æ€§"):
        st.markdown("""
        **llama3.2**
        - é€Ÿåº¦: âš¡âš¡âš¡
        - å“è³ª: â­â­â­
        - é©åˆ: é€šç”¨ä»»å‹™
        
        **mistral**
        - é€Ÿåº¦: âš¡âš¡
        - å“è³ª: â­â­â­â­
        - é©åˆ: è¤‡é›œåˆ†æ
        
        **qwen2.5**
        - é€Ÿåº¦: âš¡âš¡âš¡
        - å“è³ª: â­â­â­â­
        - é©åˆ: ä¸­æ–‡è™•ç†
        """)

# ============ ä¸»è¦å…§å®¹ ============

st.title("ğŸ¤– RAG + Ollama æ–°èåˆ†ææœå‹™")
st.markdown("### æœ¬åœ° LLM + å‘é‡æª¢ç´¢å¢å¼·ç”Ÿæˆ")

# æª¢æŸ¥ç³»çµ±ç‹€æ…‹
if not st.session_state.use_ollama:
    st.warning("âš ï¸ Ollama æœªé‹è¡Œï¼Œè«‹å…ˆå•Ÿå‹• Ollama æœå‹™")
    st.stop()

if not st.session_state.rag_system:
    st.info("ğŸ’¡ è«‹å…ˆåœ¨å´é‚Šæ¬„åˆå§‹åŒ– RAG ç³»çµ±")
    st.stop()

# æ¨™ç±¤é 
tab1, tab2, tab3, tab4 = st.tabs(["ğŸ” æœå°‹èˆ‡æ”¶é›†", "ğŸ¤– RAG å•ç­”", "ğŸ“Š æ–°èåˆ†æ", "ğŸ“ˆ çŸ¥è­˜åº«ç®¡ç†"])

# ============ Tab 1: æœå°‹èˆ‡æ”¶é›† ============
with tab1:
    st.header("ğŸ” æœå°‹æ–°èä¸¦æ·»åŠ åˆ°çŸ¥è­˜åº«")
    
    col1, col2 = st.columns([3, 1])
    with col1:
        search_keyword = st.text_input("æœå°‹é—œéµå­—", placeholder="ä¾‹å¦‚: äººå·¥æ™ºæ…§")
    with col2:
        search_limit = st.number_input("æ•¸é‡", min_value=1, max_value=50, value=10)
    
    if st.button("ğŸ” æœå°‹æ–°è", use_container_width=True, type="primary"):
        with st.spinner("æ­£åœ¨æœå°‹æ–°è..."):
            results = fetch_rss_news(limit=search_limit)
            st.session_state.search_results = results
            
            if results:
                st.success(f"âœ… æ‰¾åˆ° {len(results)} å‰‡æ–°è")
            else:
                st.warning("âš ï¸ æœªæ‰¾åˆ°æ–°è")
    
    # é¡¯ç¤ºçµæœ
    if st.session_state.search_results:
        st.markdown("---")
        st.subheader(f"ğŸ“‹ æœå°‹çµæœ ({len(st.session_state.search_results)} å‰‡)")
        
        # æ‰¹æ¬¡æ·»åŠ 
        if st.button("ğŸ“¥ å°‡æ‰€æœ‰æ–°èæ·»åŠ åˆ°çŸ¥è­˜åº«", use_container_width=True):
            with st.spinner("æ­£åœ¨æ·»åŠ ..."):
                count = st.session_state.rag_system.add_news(st.session_state.search_results)
                st.success(f"âœ… å·²æ·»åŠ  {count} å‰‡æ–°èåˆ°çŸ¥è­˜åº«")
                st.rerun()
        
        st.markdown("---")
        
        # é¡¯ç¤ºæ–°è
        for idx, news in enumerate(st.session_state.search_results):
            with st.expander(f"ğŸ“° {news['title']}", expanded=idx<3):
                col1, col2 = st.columns([3, 1])
                
                with col1:
                    st.markdown(f"**ä¾†æº:** {news['source']} | **åˆ†é¡:** {news['category']}")
                    st.markdown(f"**ç™¼å¸ƒ:** {news['published']}")
                    st.markdown(news['summary'])
                    st.markdown(f"[ğŸ”— é–±è®€å…¨æ–‡]({news['link']})")
                
                with col2:
                    if st.button("â• æ·»åŠ ", key=f"add_{idx}", use_container_width=True):
                        st.session_state.rag_system.add_news([news])
                        st.success("âœ… å·²æ·»åŠ ")
                        st.rerun()

# ============ Tab 2: RAG å•ç­” ============
with tab2:
    st.header("ğŸ¤– RAG æ™ºèƒ½å•ç­”")
    st.markdown("åŸºæ–¼æ–°èçŸ¥è­˜åº«çš„æ™ºèƒ½å•ç­”ç³»çµ±")
    
    # å•ç­”ä»‹é¢
    question = st.text_area(
        "è¼¸å…¥æ‚¨çš„å•é¡Œ",
        placeholder="ä¾‹å¦‚ï¼šæœ€è¿‘å°ç£æœ‰ä»€éº¼é‡è¦çš„ç§‘æŠ€æ–°èï¼Ÿ",
        height=100
    )
    
    col1, col2 = st.columns([2, 1])
    with col1:
        context_num = st.slider("åƒè€ƒæ–°èæ•¸é‡", min_value=1, max_value=10, value=3)
    with col2:
        if st.button("ğŸš€ æå•", use_container_width=True, type="primary"):
            if question:
                with st.spinner(f"ğŸ¤– {st.session_state.ollama_model} æ€è€ƒä¸­..."):
                    try:
                        answer, sources = st.session_state.rag_system.query_with_rag(
                            question,
                            n_context=context_num
                        )
                        
                        st.markdown("---")
                        st.subheader("ğŸ’¡ å›ç­”")
                        st.markdown(answer)
                        
                        st.markdown("---")
                        st.subheader("ğŸ“š åƒè€ƒä¾†æº")
                        for i, source in enumerate(sources):
                            with st.expander(f"ä¾†æº {i+1}: {source['metadata']['title']}", expanded=i==0):
                                st.markdown(f"**ä¾†æº:** {source['metadata']['source']}")
                                st.markdown(f"**ç›¸é—œåº¦:** {1 - source['distance']:.2%}")
                                st.markdown(source['content'])
                                
                    except Exception as e:
                        st.error(f"âŒ éŒ¯èª¤: {e}")
            else:
                st.warning("âš ï¸ è«‹è¼¸å…¥å•é¡Œ")
    
    # é è¨­å•é¡Œ
    st.markdown("---")
    st.subheader("ğŸ’¡ è©¦è©¦é€™äº›å•é¡Œ")
    
    sample_questions = [
        "æœ€è¿‘æœ‰å“ªäº›é‡è¦çš„ç§‘æŠ€æ–°èï¼Ÿ",
        "å°ç£çš„åŠå°é«”ç”¢æ¥­æœ‰ä»€éº¼æ–°ç™¼å±•ï¼Ÿ",
        "äººå·¥æ™ºæ…§æŠ€è¡“çš„æœ€æ–°è¶¨å‹¢æ˜¯ä»€éº¼ï¼Ÿ",
        "æœ€è¿‘æœ‰å“ªäº›åœ‹éš›é‡è¦äº‹ä»¶ï¼Ÿ"
    ]
    
    cols = st.columns(2)
    for idx, q in enumerate(sample_questions):
        with cols[idx % 2]:
            if st.button(q, key=f"sample_{idx}", use_container_width=True):
                st.session_state.sample_question = q
                st.rerun()

# ============ Tab 3: æ–°èåˆ†æ ============
with tab3:
    st.header("ğŸ“Š æ–°èåˆ†æ")
    
    news_text = st.text_area(
        "æ–°èå…§å®¹",
        placeholder="è²¼ä¸Šæ–°èå…§å®¹...",
        height=200
    )
    
    analysis_type = st.selectbox(
        "åˆ†æé¡å‹",
        ["æ‘˜è¦", "é—œéµå­—", "æƒ…ç·’", "5W1H"],
        format_func=lambda x: {
            "æ‘˜è¦": "ğŸ“ æ‘˜è¦ç”Ÿæˆ",
            "é—œéµå­—": "ğŸ”‘ é—œéµå­—æå–",
            "æƒ…ç·’": "ğŸ˜Š æƒ…ç·’åˆ†æ",
            "5W1H": "ğŸ“Š 5W1H åˆ†æ"
        }[x]
    )
    
    if st.button("ğŸš€ é–‹å§‹åˆ†æ", use_container_width=True, type="primary"):
        if news_text:
            with st.spinner(f"ğŸ¤– ä½¿ç”¨ {st.session_state.ollama_model} åˆ†æä¸­..."):
                try:
                    prompts = {
                        "æ‘˜è¦": "è«‹ç”¨ 2-3 å¥è©±æ‘˜è¦ä»¥ä¸‹æ–°èï¼š\n\n",
                        "é—œéµå­—": "è«‹æå–ä»¥ä¸‹æ–°èçš„ 5 å€‹é—œéµå­—ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰ï¼š\n\n",
                        "æƒ…ç·’": "è«‹åˆ†æä»¥ä¸‹æ–°èçš„æƒ…ç·’å‚¾å‘ï¼ˆæ­£é¢/ä¸­æ€§/è² é¢ï¼‰ä¸¦èªªæ˜ç†ç”±ï¼š\n\n",
                        "5W1H": "è«‹ä»¥ JSON æ ¼å¼åˆ†æä»¥ä¸‹æ–°èçš„ 5W1Hï¼ˆwho, what, when, where, why, howï¼‰ï¼š\n\n"
                    }
                    
                    prompt = prompts[analysis_type] + news_text
                    
                    response = ollama.chat(
                        model=st.session_state.ollama_model,
                        messages=[{
                            'role': 'user',
                            'content': prompt
                        }]
                    )
                    
                    result = response['message']['content']
                    
                    st.markdown("---")
                    st.subheader("ğŸ“„ åˆ†æçµæœ")
                    st.markdown(result)
                    
                    # ä¸‹è¼‰æŒ‰éˆ•
                    st.download_button(
                        "ğŸ“¥ ä¸‹è¼‰çµæœ",
                        result,
                        file_name=f"analysis_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt",
                        mime="text/plain"
                    )
                    
                except Exception as e:
                    st.error(f"âŒ åˆ†æå¤±æ•—: {e}")
        else:
            st.warning("âš ï¸ è«‹è¼¸å…¥æ–°èå…§å®¹")

# ============ Tab 4: çŸ¥è­˜åº«ç®¡ç† ============
with tab4:
    st.header("ğŸ“ˆ çŸ¥è­˜åº«ç®¡ç†")
    
    if st.session_state.rag_system:
        stats = st.session_state.rag_system.get_statistics()
        
        # çµ±è¨ˆå¡ç‰‡
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("ğŸ“° ç¸½æ–°èæ•¸", stats['total_news'])
        with col2:
            st.metric("ğŸ¤– ä½¿ç”¨æ¨¡å‹", stats['model'])
        with col3:
            st.metric("ğŸ—„ï¸ é›†åˆåç¨±", stats['collection_name'])
        
        st.markdown("---")
        
        # å‘é‡æœå°‹æ¸¬è©¦
        st.subheader("ğŸ” å‘é‡æœå°‹æ¸¬è©¦")
        test_query = st.text_input("æ¸¬è©¦æŸ¥è©¢", placeholder="è¼¸å…¥é—œéµå­—æ¸¬è©¦å‘é‡æœå°‹")
        
        if st.button("æœå°‹", use_container_width=True):
            if test_query:
                with st.spinner("æœå°‹ä¸­..."):
                    results = st.session_state.rag_system.search_similar_news(test_query, n_results=5)
                    
                    st.success(f"æ‰¾åˆ° {len(results)} å‰‡ç›¸ä¼¼æ–°è")
                    
                    for i, news in enumerate(results):
                        with st.expander(f"#{i+1} {news['metadata']['title']} (ç›¸ä¼¼åº¦: {1-news['distance']:.2%})"):
                            st.markdown(f"**ä¾†æº:** {news['metadata']['source']}")
                            st.markdown(news['content'])
        
        st.markdown("---")
        
        # æ¸…ç©ºçŸ¥è­˜åº«
        st.subheader("âš ï¸ å±éšªæ“ä½œ")
        if st.button("ğŸ—‘ï¸ æ¸…ç©ºçŸ¥è­˜åº«", type="secondary"):
            if st.checkbox("æˆ‘ç¢ºå®šè¦æ¸…ç©ºçŸ¥è­˜åº«"):
                try:
                    st.session_state.chroma_client.delete_collection(stats['collection_name'])
                    st.session_state.rag_system = None
                    st.success("âœ… çŸ¥è­˜åº«å·²æ¸…ç©º")
                    st.rerun()
                except Exception as e:
                    st.error(f"âŒ æ¸…ç©ºå¤±æ•—: {e}")

# ============ é å°¾ ============
st.markdown("---")
col1, col2, col3 = st.columns(3)
with col1:
    st.markdown("ğŸ¤– **Powered by Ollama**")
with col2:
    st.markdown("ğŸ—„ï¸ **Vector DB: ChromaDB**")
with col3:
    st.markdown("ğŸ“Š **Embedding: all-MiniLM-L6-v2**")
